---
title: fhq treapå­¦ä¹ ç¬”è®°
tags: [åŸåˆ›]
categories: [ç®—æ³•]
date: 2025-7-15
description: ğŸ¤”
articleGPT: ã€‚
---
## å‰è¨€
ã€‚

## ç®€ä»‹
fhq treapï¼Œé¡¾åæ€ä¹‰ï¼šfhq+treapã€‚

fhqï¼šå‘æ˜äººèŒƒæµ©å¼ºï¼ˆç¥çŠ‡ï¼‰çš„åå­—ç¼©å†™

treapï¼šTreeï¼ˆæ ‘ï¼‰+ Heapï¼ˆå †ï¼‰

~~okï¼Œä½ å·²ç»å­¦ä¼š fhq treap äº†ï¼Œå¿«å»åšé»‘é¢˜å§ã€‚~~

treap è®©å¹³è¡¡æ ‘ä¸Šçš„æ¯ä¸€ä¸ªç»“ç‚¹å­˜æ”¾ä¸¤ä¸ªä¿¡æ¯: å€¼å’Œä¸€ä¸ªéšæœºçš„ç´¢å¼•ã€‚å…¶ä¸­å€¼æ»¡è¶³**äºŒå‰æœç´¢æ ‘**çš„æ€§è´¨ï¼Œç´¢å¼•æ»¡è¶³å †çš„æ€§è´¨ï¼Œç»“åˆäºŒå‰æœç´¢æ ‘å’ŒäºŒå‰å †çš„æ€§è´¨æ¥ä½¿æ ‘å¹³è¡¡ã€‚

ä»€ä¹ˆï¼Ÿä½ ä¸çŸ¥é“äºŒå‰æœç´¢æ ‘ï¼Ÿ

[çŒœä½ åœ¨æœã€‚](https://oi-wiki.org/ds/bst/)

~~è¯´å®è¯æˆ‘åœ¨å­¦å¹³è¡¡æ ‘å‰ä¹Ÿä¸çŸ¥é“ï¼Œpriority_queue è¿˜æ˜¯å¤ªæœ‰ç”¨äº†ã€‚~~

æœ€å¸¸ç”¨çš„ treap æ˜¯**æ—‹è½¬ treap**ï¼Œå› ä¸ºå®ƒå¸¸æ•°å°ï¼Œä½†ç é‡å¤§ï¼Œè€Œä¸”~~ä¸æ˜¯æœ¬æ–‡ä¸»è§’~~ï¼Œä½ ç°åœ¨åªéœ€è¦çŸ¥é“å®ƒæ˜¯ç”¨æ—‹è½¬æ“ä½œç»´æŠ¤çš„å°±è¡Œäº†ã€‚

fhq treap å°±å’Œè”¼å¯äº²å¤šäº†ï¼Œä»…æœ‰ä¸¤ç§æ ¸å¿ƒæ“ä½œï¼Œå³ä¸º**åˆ†è£‚**ä¸**åˆå¹¶**ï¼Œæ‰€ä»¥åˆç§°åˆå¹¶treapï¼Œæ•´ä½“ä¸Šæ¯”æ—‹è½¬ treap æ–¹ä¾¿ä¸”å¯å®ç°æ“ä½œæ›´å¤šï¼Œä½†å¸¸æ•°ç•¥å¤§ã€‚

## å®ç°
æˆ‘ä»¬éœ€è¦ä¿å­˜è¿™äº”ä¸ªä¿¡æ¯ï¼š
- å·¦å³å­æ ‘ç¼–å·
- å€¼
- ç´¢å¼•
- å­æ ‘å¤§å°

### åˆ†è£‚
åˆ†è£‚ä¸€èˆ¬æœ‰ä¸¤ç§ï¼ŒæŒ‰å€¼åˆ†è£‚ä¸æŒ‰å¤§å°åˆ†è£‚ï¼Œçœ‹é¢˜ç›®è¦æ±‚ä½¿ç”¨ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ fhq Treap å½“ä¸€æ£µæ­£å¸¸çš„å¹³è¡¡æ ‘ç”¨çš„æ—¶å€™ï¼Œä½¿ç”¨æŒ‰å€¼åˆ†è£‚ï¼›è€Œåœ¨ç»´æŠ¤åŒºé—´ä¿¡æ¯çš„æ—¶å€™ï¼Œä½¿ç”¨æŒ‰å¤§å°åˆ†è£‚ï¼ˆæ¯”å¦‚[æ–‡è‰ºå¹³è¡¡æ ‘](https://www.luogu.com.cn/problem/P3391)ï¼‰ã€‚

ç¤ºæ„å›¾ï¼š

![](https://cdn.luogu.com.cn/upload/image_hosting/1nznr9wc.png)

å°†æ­¤å›¾å¯¹ 15 åˆ†è£‚ã€‚

![](https://cdn.luogu.com.cn/upload/image_hosting/om4fn9un.png)

### åˆå¹¶

åˆå¹¶å°±æ˜¯æŠŠä¸¤é¢—æ ‘ xï¼Œy åˆå¹¶æˆä¸€æ£µæ ‘ï¼Œå…¶ä¸­ x æ ‘ä¸Šçš„æ‰€æœ‰å€¼éƒ½å°äºç­‰äº y æ ‘ä¸Šçš„æ‰€æœ‰å€¼ã€‚å¹¶ä¸”æ–°åˆå¹¶å‡ºæ¥çš„æ ‘ä¾æ—§æ»¡è¶³ Treap çš„æ€§è´¨ã€‚

~~æŠŠä¸Šé¢ä¸¤å¼ å›¾å€’åºçœ‹ä¸€éå°±æ˜¯åˆå¹¶äº†ã€‚~~

### æ“ä½œ

é‚£åˆ†è£‚ä¸åˆå¹¶æœ‰å•¥ç”¨å•Šï¼Ÿ

- **æ’å…¥ï¼š** éå¸¸ç®€å•ï¼Œåªéœ€ä¸¤æ­¥ã€‚  
å‡è®¾æˆ‘ä»¬è¦å°†å€¼ $v$ æ’å…¥æ ‘ $A$ï¼Œé‚£æˆ‘ä»¬åªéœ€è¦å°† $A$ æŒ‰å€¼ $v$ åˆ†è£‚ä¸º $X$ ä¸ $Y$ï¼Œå†ä»¥ $v$ ä¸ºå€¼æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹ $Z$ï¼Œå†åˆå¹¶ $X,Y,Z$ å³å¯ã€‚

- **åˆ é™¤ï¼š** ä¸Šé¢çš„æ’å…¥åªéœ€ä¸¤æ­¥ï¼Œä½†åˆ é™¤è¦å››æ­¥ğŸ‘ï¼Œä»¥åˆ é™¤å€¼ $v$ ä¸ºä¾‹ã€‚  
é¦–å…ˆï¼ŒæŒ‰å€¼ $v$ æŠŠæ ‘åˆ†è£‚æˆ $X$ å’Œ $Z$ã€‚  
å†æŒ‰å€¼ $v-1$ æŠŠ $X$ æ ‘åˆ†è£‚æˆ $X$ å’Œ $Y$ã€‚  
é‚£ä¹ˆæ­¤æ—¶ $Y$ æ ‘ä¸Šçš„æ‰€æœ‰å€¼éƒ½æ˜¯ç­‰äº $v$ çš„ï¼Œæˆ‘ä»¬å»æ‰å®ƒçš„æ ¹èŠ‚ç‚¹: è®© $Y$ ç­‰äºåˆå¹¶ $Y$ çš„å·¦å­æ ‘å’Œå³å­æ ‘ã€‚  
æœ€åï¼Œåˆå¹¶ $X,Y,Z$ã€‚

- **æŸ¥è¯¢æ’åï¼š** ä¹Ÿå¾ˆç®€å•ï¼Œè®¾è¦æŸ¥è¯¢çš„å€¼ä¸º $v$ã€‚  
æŒ‰å€¼ $v-1$ åˆ†è£‚æˆ $X$ å’Œ $Y$ã€‚
åˆ™ $x$ çš„å¤§å° $\text{size}+1$ å°±æ˜¯ $v$ çš„æ’å
æœ€åå†æŠŠ $X$ å’Œ $Y$ åˆå¹¶èµ·æ¥


- **å‰é©±åç»§ï¼š** æŒ‰å€¼ $v$ åˆ†è£‚ä¸ºå­æ ‘ $X$ ä¸ $Y$ã€‚  
å‰é©±å°±æ˜¯ $X$ ä¸­æ’åæœ€å¤§çš„èŠ‚ç‚¹ï¼›åç»§åŒç†ï¼Œæ˜¯ $Y$ ä¸­æ’åæœ€å°çš„èŠ‚ç‚¹ã€‚

## ä¸å­˜ç´¢å¼•çš„ fhq treap
è¿™ä¸€ç‚¹ç–‘ä¼¼åœ¨ OI Wiki ä¸Šæ²¡æœ‰æåŠï¼Œä½†ä¹Ÿæœ‰ä¸å°‘äººè¿™æ ·å†™çš„ï¼Œå°±æ˜¯å°†ç»´æŠ¤å †ç‰¹æ€§çš„ä»£ç æ”¹æˆå…¶å®ƒçš„è®©æ ‘éšæœºåˆå¹¶çš„è¯­å¥ï¼Œæ¯”å¦‚ $\text{rand} ()\&1$ï¼Œä½†[äº‹å®](https://www.luogu.com.cn/discuss/123169)è¯æ˜ï¼Œè¿™ç§å†™æ³•çš„æ—¶é—´å¤æ‚åº¦è¿‡äºç„å­¦ï¼Œä½†è¿™æ ·å‡ºé¢˜äººå¤§æ¦‚ç‡å¡ä¸äº†ä½ ï¼Œ~~è¿æ°”è¿‡å·®é™¤å¤–~~ã€‚

è¿˜æœ‰äººå†™æˆå°† $x$ åˆå¹¶åˆ° $y$ çš„æ¦‚ç‡ä¸º $\frac{\text{size}(x)}{\text{size}(x)+\text{size}(y)}$ã€‚

## [æ¨¡æ¿](https://www.luogu.com.cn/problem/P3369)ä»£ç 

```cpp
#include <iostream>
#include <ctime>
#include <cstdio>
const int maxn = 1e5+5;
struct Node
{
    int l,r;
    int val,key;
    int size;
}fhq[maxn];
int cnt,root;
#include <random>
std::mt19937 rnd(233);
inline int newnode(int val)
{
    fhq[++cnt].val=val;
    fhq[cnt].key=rnd();
    fhq[cnt].size=1;
    return cnt;
}
inline void update(int now)
{
    fhq[now].size=fhq[fhq[now].l].size+fhq[fhq[now].r].size+1;
}
void split(int now,int val,int &x,int &y)
{
    if(!now) x=y=0;
    else 
    {
        if(fhq[now].val<=val)
        {
            x=now;
            split(fhq[now].r,val,fhq[now].r,y);
        }
        else 
        {
            y=now;
            split(fhq[now].l,val,x,fhq[now].l);
        }
        update(now);
    }
}
int merge(int x,int y)
{
    if(!x||!y) return x+y;
    if(fhq[x].key>fhq[y].key)           // > >= < <=
    {
        fhq[x].r=merge(fhq[x].r,y);
        update(x);
        return x;
    }
    else 
    {
        fhq[y].l=merge(x,fhq[y].l);
        update(y);
        return y;
    }
}
int x,y,z;
inline void ins(int val)
{
    split(root,val,x,y);
    root=merge(merge(x,newnode(val)),y);
}
inline void del(int val)
{
    split(root,val,x,z);
    split(x,val-1,x,y);
    y=merge(fhq[y].l,fhq[y].r);
    root=merge(merge(x,y),z);
}
inline void getrank(int val)
{
    split(root,val-1,x,y);
    printf("%d\n", fhq[x].size+1);
    root=merge(x,y);
}
inline void getnum(int rank)
{
    int now=root;
    while(now)
    {
        if(fhq[fhq[now].l].size+1==rank)
            break;
        else if(fhq[fhq[now].l].size>=rank)
            now=fhq[now].l;
        else 
        {
            rank-=fhq[fhq[now].l].size+1;
            now=fhq[now].r;
        }
    }
    printf("%d\n", fhq[now].val);
}
inline void pre(int val)
{
    split(root,val-1,x,y);
    int now = x;
    while(fhq[now].r)
        now = fhq[now].r;
    printf("%d\n", fhq[now].val);
    root=merge(x,y);
}
inline void nxt(int val)
{
    split(root,val,x,y);
    int now = y;
    while(fhq[now].l)
        now = fhq[now].l;
    printf("%d\n", fhq[now].val);
    root=merge(x,y);
}
int main()
{
    int t; scanf("%d",&t);
    while(t--)
    {
        int opt,x; scanf("%d%d",&opt,&x);
        switch(opt)
        {
            case 1:
                ins(x);
                break;
            case 2:
                del(x);
                break;
            case 3:
                getrank(x);
                break;
            case 4:
                getnum(x);
                break;
            case 5:
                pre(x);
                break;
            case 6:
                nxt(x);
                break;
        }
    }
    return 0;
}
```

Aï¼šä¸æ˜¯å¾ˆå¥½å†™å—ï¼Œæ€ä¹ˆè¿™ä¹ˆé•¿ï¼Ÿ  
ä½ å»çœ‹çœ‹åˆ«çš„å¹³è¡¡æ ‘ï¼Ÿ  
Aï¼šâ€¦â€¦  
Aï¼šé‚£[è¿™](https://tsh1203.github.io/posts/2024/1028)[ä¸ª](https://www.luogu.com.cn/article/br47p1nr)å‘¢ï¼Ÿ   
ã€‚
## [å¤„ç†åŒºé—´çš„ fhq treap](https://www.luogu.com.cn/problem/P3391)

æŒ‚ä¸ªä»£ç å§
```cpp
#include <iostream>
#include <ctime>
#include <cstdio>
const int maxn = 1e5+5;
struct Node
{
    int l,r;
    int val,key;
    int size;
    bool reverse;
}fhq[maxn];
int cnt,root;
#include <random>
std::mt19937 rnd(233);
inline int newnode(int val)
{
    fhq[++cnt].val=val;
    fhq[cnt].key=rnd();
    fhq[cnt].size=1;
    return cnt;
}
inline void update(int now)
{
    fhq[now].size=fhq[fhq[now].l].size+fhq[fhq[now].r].size+1;
}
inline void pushdown(int now)
{
    std::swap(fhq[now].l,fhq[now].r);
    fhq[fhq[now].l].reverse^=1;
    fhq[fhq[now].r].reverse^=1;
    fhq[now].reverse=false;
}
void split(int now,int siz,int &x,int &y)
{
    if(!now) x=y=0;
    else 
    {
        if(fhq[now].reverse) pushdown(now);
        if(fhq[fhq[now].l].size<siz)
        {
            x=now;
            split(fhq[now].r,siz-fhq[fhq[now].l].size-1,fhq[now].r,y);
        }
        else 
        {
            y=now;
            split(fhq[now].l,siz,x,fhq[now].l);
        }
        update(now);
    }
}
int merge(int x,int y)
{
    if(!x||!y) return x+y;
    if(fhq[x].key<fhq[y].key)
    {
        if(fhq[x].reverse) pushdown(x);
        fhq[x].r=merge(fhq[x].r,y);
        update(x);
        return x;
    }
    else 
    {
        if(fhq[y].reverse) pushdown(y);
        fhq[y].l=merge(x,fhq[y].l);
        update(y);
        return y;
    }
}
void reverse(int l,int r)
{
    int x,y,z;
    split(root,l-1,x,y);
    split(y,r-l+1,y,z);
    fhq[y].reverse^=1;
    root=merge(merge(x,y),z);
}
void ldr(int now)
{
    if(!now) return;
    if(fhq[now].reverse) pushdown(now);
    ldr(fhq[now].l);
    printf("%d ", fhq[now].val);
    ldr(fhq[now].r);
}
int main()
{
    int n,m; scanf("%d%d",&n,&m);
    for(int i=1;i<=n;i++)
        root=merge(root,newnode(i));
    while(m--)
    {
        int l,r; scanf("%d%d",&l,&r);
        reverse(l,r);
    }
    ldr(root);
    return 0;
}
```
æ³¨ï¼šè¿™é¢˜æˆ‘å†™å¾—è¿‡äºæŠ½è±¡ï¼Œæ‹¿çš„åŒå­¦çš„ä»£ç ã€‚

## åè®°

ç»ˆäºå†™å®Œäº†ï¼Œè™½ç„¶æ¶å¿ƒï¼Œä½†æ€»æ¯”æ—‹è½¬ treap å¥½å†™ğŸ‘ã€‚
